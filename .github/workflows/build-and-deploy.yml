name: Build and Deploy

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  REGISTRY: 10.9.8.121:5000
  IMAGE_NAME: sourdough-docs

jobs:
  build-and-push:
    runs-on: self-hosted
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Generate build metadata
      id: meta
      run: |
        # Generate version tag based on commit SHA and timestamp
        VERSION="${{ github.sha }}-$(date +%Y%m%d%H%M%S)"
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        
        # Generate tags
        if [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref }}" = "refs/heads/main" ]; then
          TAGS="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest,${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${VERSION}"
        else
          TAGS="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${VERSION}"
        fi
        echo "tags=${TAGS}" >> $GITHUB_OUTPUT
    
    - name: Build Docker image
      run: |
        # Build the Docker image with all tags
        for tag in $(echo "${{ steps.meta.outputs.tags }}" | tr ',' ' '); do
          docker build -t "${tag}" .
        done
    
    - name: Test image
      run: |
        # Test that the image runs
        docker run --rm -d --name test-container -p 8080:80 ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }}
        sleep 5
        # Check if nginx is responding
        curl -f http://localhost:8080 || (docker logs test-container && exit 1)
        docker stop test-container
    
    - name: Push to registry
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      env:
        REGISTRY_USERNAME: ${{ secrets.REGISTRY_USERNAME }}
        REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}
      run: |
        # Login to registry with credentials from GitHub secrets
        echo "${REGISTRY_PASSWORD}" | docker login --username "${REGISTRY_USERNAME}" --password-stdin 10.9.8.121:5000
        
        # Push all tags to the registry
        for tag in $(echo "${{ steps.meta.outputs.tags }}" | tr ',' ' '); do
          echo "Pushing ${tag}..."
          docker push "${tag}"
        done
    
    - name: Deploy to Docker Swarm
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        # Check if we can deploy to swarm
        SWARM_MANAGER="10.9.8.120"
        
        # Option 1: If this runner is the swarm manager
        if docker node ls >/dev/null 2>&1; then
          echo "🚀 Deploying to Docker Swarm (local manager)..."
          docker stack deploy -c docker-compose.swarm.yml sourdough
          sleep 10
          docker service ls | grep sourdough
          docker service ps sourdough_sourdough-docs
        
        # Option 2: If we can SSH to the swarm manager
        elif ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=no ${SWARM_MANAGER} "echo 'Connected'" >/dev/null 2>&1; then
          echo "🚀 Deploying to Docker Swarm via SSH to manager..."
          scp docker-compose.swarm.yml ${SWARM_MANAGER}:/tmp/
          ssh ${SWARM_MANAGER} "sudo /etc/docker/creds/login-registry.sh && sudo docker stack deploy -c /tmp/docker-compose.swarm.yml sourdough && rm /tmp/docker-compose.swarm.yml"
          echo "✅ Deployed to Swarm via remote manager"
        
        else
          echo "⚠️ Cannot deploy to Swarm automatically. Manual deployment required."
          echo "Run: ./scripts/deploy-to-swarm-remote.sh"
        fi
    
    - name: Output deployment info
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        echo "### 🚀 Docker Image Deployed!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Registry:** ${{ env.REGISTRY }}" >> $GITHUB_STEP_SUMMARY
        echo "**Image:** ${{ env.IMAGE_NAME }}" >> $GITHUB_STEP_SUMMARY
        echo "**Version:** ${{ steps.meta.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Pull command:**" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if docker node ls >/dev/null 2>&1; then
          echo "**Swarm Deployment:** ✅ Deployed to swarm-worker-2" >> $GITHUB_STEP_SUMMARY
          echo "**Access URL:** http://swarm-worker-2:8081" >> $GITHUB_STEP_SUMMARY
        else
          echo "**Swarm Deployment:** ⚠️ Manual deployment required (runner is not a swarm manager)" >> $GITHUB_STEP_SUMMARY
        fi